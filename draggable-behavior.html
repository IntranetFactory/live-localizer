<!--
@license https://github.com/t2ym/live-localizer/blob/master/LICENSE.md
Copyright (c) 2016, Tetsuya Mori <t2y3141592@gmail.com>. All rights reserved.
-->
<link rel="import" href="../polymer/polymer.html">

<dom-module id="drag-handle-mode">
  <template>
    <style>
      [drag-handle-mode=upper-left] {
        cursor: nwse-resize;
      }
      [drag-handle-mode=upper] {
        cursor: ns-resize;
      }
      [drag-handle-mode=upper-right] {
        cursor: nesw-resize;
      }
      [drag-handle-mode=middle-left] {
        cursor: ew-resize;
      }
      [drag-handle-mode=position] {
        cursor: move;
      }
      [drag-handle-mode=middle-right] {
        cursor: ew-resize;
      }
      [drag-handle-mode=lower-left] {
        cursor: nesw-resize;
      }
      [drag-handle-mode=lower] {
        cursor: ns-resize;
      }
      [drag-handle-mode=lower-right] {
        cursor: nwse-resize;
      }
      [drag-handle-mode=drag] {
        cursor: -moz-grab;
        cursor: -webkit-grab;
        cursor: grab;
      }
      .drag-target {
        cursor: -moz-grab;
        cursor: -webkit-grab;
        cursor: grab;
      }
      .drag-target[drag-state=dragging] {
        cursor: -moz-grabbing;
        cursor: -webkit-grabbing;
        cursor: grabbing;
      }
      .drop-target {
        cursor: copy;
      }
    </style>
  </template>
</dom-module>
<dom-module id="drag-field">
  <template>
    <style>
      .drag-field {
        z-index: 0;
      }
      .drag-target {
        z-index: 1;
      }
      .drop-target {
        z-index: 2;
        opacity: 0.75;
      }
      .drop-target[drag-state=drag-hover] {
        opacity: 0.25;
        margin: 4px;
        border-color: darkblue;
        border-width: 4px;
        border-style: solid;
        border-radius: 12px;
      }

    </style>
  </template>
</dom-module>

<script>
window.BehaviorsStore = window.BehavirosStore || {};

/**
 * Apply `BehaviorsStore.DraggableBehavior` to implement draggable and resizable elements.
 *
 * @polymerBehavior BehaviorsStore.DraggableBehavior
 * @group I18nBehavior
 * @hero hero.svg
 * @demo demo/index.html
 */
BehaviorsStore.DraggableBehavior = {
  properties: {
    x: {
      type: Number,
      value: 0
    },
    y: {
      type: Number,
      value: 0
    },
    width: {
      type: Number,
      value: 0
    },
    height: {
      type: Number,
      value: 0
    },
    dx: {
      type: Number,
      value: 0
    },
    dy: {
      type: Number,
      value: 0
    },
    dragState: {
      type: String,
      value: 'released',
      reflectToAttribute: true
    },
    dragHandleMode: {
      type: String,
      value: 'position',
      reflectToAttribute: true
    },
    fullscreen: {
      type: Boolean,
      value: false,
      reflectToAttribute: true
    },
    resizable: {
      type: Boolean,
      value: false,
      reflectToAttribute: true
    },
    dragDropGroups: {
      type: String,
      reflectToAttribute: true
    },
    dropTargets: {
      type: String,
      reflectToAttribute: true
    }
  },

  observers: [
    '_onXChange(x,fullscreen)',
    '_onYChange(y,fullscreen)',
    '_onWidthChange(width,fullscreen)',
    '_onHeightChange(height,fullscreen)'
  ],

  listeners: {
    'track': '_handleTrack',
    'mouseover': 'onMouseOver',
    'mouseenter': 'onMouseOver',
    'mouseup': 'onMouseOver',
    'mouseleave': 'onMouseOver',
    'mouseout': 'onMouseOver'
  },

  // shared property
  dragDropGroupMembers: {},

  ready: function () {
    if (this.dragDropGroups) {
      this.dragDropGroups.split(/[ ]{1,}/).forEach(function (group) {
        this.dragDropGroupMembers[group] = this.dragDropGroupMembers[group] || new Array();
        this.dragDropGroupMembers[group].push(this);
      }, this);
    }
  },

  attached: function () {
    this._onWindowResize = function (e) {
      if (this.fullscreen && this.resizable) {
        if (Number(this.style.height.replace(/px$/, '')) !== window.innerHeight) {
          this.style.height = window.innerHeight + 'px';
        }
      }
    }.bind(this);
    window.addEventListener('resize', this._onWindowResize);
  },

  detached: function () {
    window.removeEventListener('resize', this._onWindowResize);
  },

  _onXChange: function (x, fullscreen) {
    this.style.left = (fullscreen ? 0 : x) + 'px';
  },

  _onYChange: function (y, fullscreen) {
    this.style.top = (fullscreen ? 0 : y) + 'px';
  },

  _onWidthChange: function (width, fullscreen) {
    if (this.resizable) {
      this.style.width = fullscreen ? '100%' : width + 'px';
    }
  },

  _onHeightChange: function (height, fullscreen) {
    if (this.resizable) {
      this.style.height = (fullscreen ? window.innerHeight : height) + 'px';
      this.fire('height-changed');
    }
  },

  _handleTrack: function (e) {
    switch (e.detail.state) {
    case 'start':
      this.dragState = 'dragged';
      this.dragHandleMode = this.getDragHandleMode(e);
      switch (this.dragHandleMode) {
      case 'drag':
        this.toggleClass('drag-target', true, this);
        this.dropTarget = null;
        if (this.dropTargets) {
          this.dropTargets.split(/[ ]{1,}/).forEach(function (targetGroup) {
            if (this.dragDropGroupMembers[targetGroup]) {
              this.dragDropGroupMembers[targetGroup].forEach(function (target) {
                target.toggleClass('drop-target', true, target);
              });
            }
          }, this);
        }
        break;
      default:
        this.toggleClass('drag-target', false, this);
        break;
      }
      break;
    case 'track':
      this.dragState = 'dragging';
      this.dx = Number(e.detail.dx);
      this.dy = Number(e.detail.dy);
      switch (this.dragHandleMode) {
      case 'position':
      case 'drag':
        this.style.left = (Number(this.x) + Number(this.dx)) + 'px';
        this.style.top = (Number(this.y) + Number(this.dy)) + 'px';
        break;
      case 'upper-left':
        this.style.left = (Number(this.x) + Number(this.dx)) + 'px';
        this.style.top = (Number(this.y) + Number(this.dy)) + 'px';
        this.style.width = (Number(this.width) - Number(this.dx)) + 'px';
        this.style.height = (Number(this.height) - Number(this.dy)) + 'px';
        this.fire('height-changed');
        break;
      case 'upper':
        this.style.top = (Number(this.y) + Number(this.dy)) + 'px';
        this.style.height = (Number(this.height) - Number(this.dy)) + 'px';
        this.fire('height-changed');
        break;
      case 'upper-right':
        this.style.top = (Number(this.y) + Number(this.dy)) + 'px';
        this.style.width = (Number(this.width) + Number(this.dx)) + 'px';
        this.style.height = (Number(this.height) - Number(this.dy)) + 'px';
        this.fire('height-changed');
        break;
      case 'middle-left':
        this.style.left = (Number(this.x) + Number(this.dx)) + 'px';
        this.style.width = (Number(this.width) - Number(this.dx)) + 'px';
        break;
      case 'middle-right':
        this.style.width = (Number(this.width) + Number(this.dx)) + 'px';
        break;
      case 'lower-left':
        this.style.left = (Number(this.x) + Number(this.dx)) + 'px';
        this.style.width = (Number(this.width) - Number(this.dx)) + 'px';
        this.style.height = (Number(this.height) + Number(this.dy)) + 'px';
        this.fire('height-changed');
        break;
      case 'lower':
        this.style.height = (Number(this.height) + Number(this.dy)) + 'px';
        this.fire('height-changed');
        break;
      case 'lower-right':
        this.style.width = (Number(this.width) + Number(this.dx)) + 'px';
        this.style.height = (Number(this.height) + Number(this.dy)) + 'px';
        this.fire('height-changed');
        break;
      default:
        break;
      }
      break;
    default:
    case 'end':
      switch (this.dragHandleMode) {
      case 'drag':
        this.x = Number(this.x) + Number(this.dx);
        this.y = Number(this.y) + Number(this.dy);
        this.x = Number(this.x) - Number(this.dx);
        this.y = Number(this.y) - Number(this.dy);
        this.toggleClass('drag-target', false, this);
        if (this.dropTargets) {
          this.dropTargets.split(/[ ]{1,}/).forEach(function (targetGroup) {
            if (this.dragDropGroupMembers[targetGroup]) {
              this.dragDropGroupMembers[targetGroup].forEach(function (target) {
                target.toggleClass('drop-target', false, target);
                if (target.dragState === 'dropped') {
                  this.dropTarget = target;
                  target.dragState = 'released';
                }
              }, this);
            }
          }, this);
        }
        if (this.dropTarget) {
          //console.log('drag-and-drop src = ', this, 'dest = ', this.dropTarget);
          this.fire('drag-and-drop', { src: this, dest: this.dropTarget });
        }
        break;
      case 'position':
        this.x = Number(this.x) + Number(this.dx);
        this.y = Number(this.y) + Number(this.dy);
        break;
      case 'upper-left':
        this.x = Number(this.x) + Number(this.dx);
        this.y = Number(this.y) + Number(this.dy);
        this.width = Number(this.width) - Number(this.dx);
        this.height = Number(this.height) - Number(this.dy);
        break;
      case 'upper':
        this.y = Number(this.y) + Number(this.dy);
        this.height = Number(this.height) - Number(this.dy);
        break;
      case 'upper-right':
        this.y = Number(this.y) + Number(this.dy);
        this.width = Number(this.width) + Number(this.dx);
        this.height = Number(this.height) - Number(this.dy);
        break;
      case 'middle-left':
        this.x = Number(this.x) + Number(this.dx);
        this.width = Number(this.width) - Number(this.dx);
        break;
      case 'middle-right':
        this.width = Number(this.width) + Number(this.dx);
        break;
      case 'lower-left':
        this.x = Number(this.x) + Number(this.dx);
        this.width = Number(this.width) - Number(this.dx);
        this.height = Number(this.height) + Number(this.dy);
        break;
      case 'lower':
        this.height = Number(this.height) + Number(this.dy);
        break;
      case 'lower-right':
        this.width = Number(this.width) + Number(this.dx);
        this.height = Number(this.height) + Number(this.dy);
        break;
      default:
        break;
      }
      this.dx = 0;
      this.dy = 0;
      this.dragState = 'released';
      this.dragHandleMode = this.getDragHandleMode(e);
      break;
    }
    //console.log('x = ', this.x, ' y = ', this.y, ' left = ', this.style.left, ' top = ', this.style.top, ' width = ', this.style.width, ' height = ', this.style.height, ' dx = ', this.dx, ' dy = ', this.dy);
  },

  onMouseOver: function (e) {
    if (this.classList.contains('drop-target')) {
      switch (e.type) {
      case 'mouseenter':
        this.dragState = 'drag-hover';
        break;
      case 'mouseleave':
        this.dragState = 'released';
        break;
      case 'mouseup':
        this.dragState = 'dropped';
        break;
      default:
        break;
      }
    }
    //console.log(this.is, e.type, this.dragState);
  },

  getDragHandleMode: function (e) {
    return 'position';
  }
};
</script>

